# Express-BookStack üìö

> **Microservi√ßo Backend para Gerenciamento de Livros**  
> API RESTful robusta constru√≠da com Node.js, Express, TypeScript e MongoDB

## üéØ **Vis√£o Geral**

Este projeto √© um **desafio t√©cnico** que demonstra maestria em:
- **Node.js & Express** - Arquitetura escal√°vel e moderna
- **TypeScript** - Tipagem forte e desenvolvimento seguro  
- **MongoDB & Mongoose** - Banco de dados NoSQL com ODM
- **JWT Authentication** - Sistema de autentica√ß√£o seguro
- **Observabilidade** - Logs, m√©tricas e monitoramento
- **Testes Completos** - Unit√°rios e de integra√ß√£o
- **Docker** - Containeriza√ß√£o e deploy

---

## üèóÔ∏è **Arquitetura Backend**

### **Estrutura de Pastas**
```
src/
‚îú‚îÄ‚îÄ üìÅ config/          # Configura√ß√µes (DB, CORS, Cookies, Env)
‚îú‚îÄ‚îÄ üìÅ controllers/     # Controladores de rotas
‚îú‚îÄ‚îÄ üìÅ repositories/    # Camada de acesso a dados
‚îú‚îÄ‚îÄ üìÅ services/        # L√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ üìÅ middlewares/     # Middlewares do Express
‚îú‚îÄ‚îÄ üìÅ models/          # Modelos e tipos TypeScript
‚îú‚îÄ‚îÄ üìÅ schemas/         # Valida√ß√µes Zod
‚îú‚îÄ‚îÄ üìÅ routes/          # Defini√ß√£o de rotas
‚îú‚îÄ‚îÄ üìÅ helpers/         # Utilit√°rios e helpers
‚îú‚îÄ‚îÄ üìÅ database/        # Configura√ß√£o MongoDB
‚îî‚îÄ‚îÄ üìÅ __tests__/       # Testes unit√°rios e integra√ß√£o
```

### **Padr√£o de Arquitetura em Camadas**

**1. Routes ‚Üí Controllers ‚Üí Services ‚Üí Repositories ‚Üí Database**

```typescript
// üîÑ Fluxo de uma requisi√ß√£o
Request ‚Üí Middleware ‚Üí Route ‚Üí Controller ‚Üí Service ‚Üí Repository ‚Üí MongoDB
```

---

## üõ°Ô∏è **Sistema de Middlewares**

### **1. Error Handler Centralizado**
```typescript
// src/middlewares/errorHandler.middleware.ts
export const errorHandler = (err: any, req: Request, res: Response, next: NextFunction) => {
  console.error("üö® ERRO:", err.message);
  
  if (err instanceof CustomError) {
    res.status(err.status).send(badRespObj({ message: err.message }));
  } else {
    res.status(500).send(badRespObj({ message: err.message }));
  }
};
```
**Por que usar?** Centraliza o tratamento de erros, evita duplica√ß√£o de c√≥digo e garante respostas consistentes.

### **2. Valida√ß√£o de Entrada (Zod)**
```typescript
// src/middlewares/validation.middleware.ts
const validate = (schema: ZodType, type: "body" | "params" | "query") => {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      schema.parse(req[type]);
      next();
    } catch (error) {
      if (error instanceof ZodError) {
        const firstError = error.issues[0];
        const errMessage = extractErrorMessage(firstError);
        next(new CustomError(errMessage, 400));
      }
    }
  };
};
```

**Esquemas de Valida√ß√£o:**
```typescript
// src/schemas/book.schema.ts
export const bookSchema = z.object({
  isbn: z.string().trim().min(1).max(20).regex(/^[\d\-X]+$/),
  name: z.string().trim().min(1).max(200),
  author: z.string().trim().min(1).max(100),
  stock: z.number().int().min(0).default(0),
});

// src/schemas/bookQuery.schema.ts - Valida√ß√£o de query parameters
export const bookQuerySchema = z.object({
  page: z.string().optional().default("1").transform(val => parseInt(val, 10)),
  limit: z.string().optional().default("10").transform(val => parseInt(val, 10)),
  favorites: z.string().optional().refine(val => ["true", "false", "1", "0"].includes(val))
});
```

### **3. Sistema de Autentica√ß√£o JWT**
```typescript
// src/middlewares/authentication.middleware.ts
export const validToken = async (req: AuthReq, res: Response, next: NextFunction) => {
  try {
    const authHeader = req.headers.authorization;
    const token = authHeader.replace("Bearer ", "");
    
    const decoded = jwt.verify(token, env.ACCESS_TOKEN_SECRET) as { user: string };
    const user = await getUserById(decoded.user);
    
    req.user = decoded.user;
    next();
  } catch (error) {
    if (error instanceof jwt.TokenExpiredError) {
      return next(new CustomError("Token expirado", 401));
    }
    next(error);
  }
};
```

**Gera√ß√£o de Tokens:**
```typescript
// src/service/auth.service.ts
export const signin = async (data: UserAcess): Promise<Tokens> => {
  // Verifica√ß√£o de credenciais
  const isValidPassword = await bcrypt.compare(data.password, user.password);
  
  // Gera√ß√£o de tokens
  const refreshToken = jwt.sign({ user: user._id }, env.REFRESH_TOKEN_SECRET, {
    expiresIn: "3d",
  });
  
  const accessToken = jwt.sign({ user: user._id }, env.ACCESS_TOKEN_SECRET, {
    expiresIn: "1h",
  });
  
  return { refreshToken, accessToken };
};
```

### **4. Logger para Observabilidade**
```typescript
// src/middlewares/logger.middleware.ts
export const logger = (req: Request, res: Response, next: NextFunction) => {
  const startTime = Date.now();

  res.on("finish", async () => {
    const responseTime = Date.now() - startTime;
    const userID = (req as any).user?._id?.toString();
    const feature = getFeature(req.path); // books, auth, users

    await Log.create({
      method: req.method,
      route: req.path,
      statusCode: res.statusCode,
      responseTime,
      userID,
      feature,
      error: res.statusCode >= 400 ? `HTTP ${res.statusCode}` : undefined,
    });
  });

  next();
};
```

---

## üì° **Padr√£o de Resposta Unificado**

### **Comunica√ß√£o Frontend-Backend Padronizada**
```typescript
// src/helpers/responsePattern.helper.ts

// ‚úÖ Resposta de Sucesso
const respObj = ({ data = [], message = "" }: ServiceRes) => {
  return { success: true, data, message };
};

// ‚ùå Resposta de Erro  
const badRespObj = ({ message }: badServiceRes) => {
  return { success: false, message };
};
```

**Exemplo de Uso em Service:**
```typescript
// src/service/book.service.ts
export const getAllBooksByUser = async (userID: string, bookQuery: BookQuery): Promise<ServiceRes> => {
  const result = await repository.getAllBooksByUser(userID, bookQuery);
  return returnData(result);
};

// Resposta padronizada:
{
  "success": true,
  "data": {
    "books": [...],
    "pagination": { "currentPage": 1, "totalPages": 5 }
  },
  "message": "Livros obtidos com sucesso"
}
```

**Por que usar?** Garante consist√™ncia, facilita tratamento no frontend e melhora DX.

---

## üìä **Sistema de Observabilidade**

### **Modelo de Log Unificado**
```typescript
// src/models/log.model.ts
export interface ILog {
  method: string;      // GET, POST, PUT, DELETE
  route: string;       // /books, /auth/signin  
  statusCode: number;  // 200, 404, 500
  responseTime: number; // ms
  ip: string;          // Cliente IP
  userID?: string;     // ID do usu√°rio autenticado
  feature?: string;    // books, auth, users, system
  error?: string;      // Mensagem de erro se status >= 400
  timestamp: Date;     // Quando ocorreu
}
```

### **M√©tricas em Tempo Real**
```typescript
// src/service/log.service.ts

// üî¥ Taxa de erro 500 nas √∫ltimas 24h
export const getError500Rate = async () => {
  const total = await repository.getTotalLogs(last24h);
  const errors500 = await repository.getError500Count(last24h);
  
  return {
    total,
    errors500, 
    rate: total > 0 ? ((errors500 / total) * 100).toFixed(2) : "0.00",
  };
};

// üî• Heat map de funcionalidades
export const getHeatMap = async () => {
  return await repository.getHeatMapData(last24h);
  // Retorna: [{ feature: "books", requests: 150, uniqueUsers: 25 }]
};

// üêå Rotas mais lentas
export const getSlowestRoutes = async () => {
  return await repository.getSlowestRoutesData(last24h);  
  // Retorna: [{ endpoint: "GET /books", avgTime: 450, requests: 100 }]
};
```

---

## üöÄ **Funcionalidades por Rotas**

### **üìö Livros (`/books`)**
```typescript
// src/routes/book.route.ts
router.get("/", validToken, validQuery(bookQuerySchema), getAllBooks);
router.post("/", validToken, validBody(bookSchema), createBook);
router.get("/:isbn", validToken, validParams(bookParamsSchema), getBookByIsbn);
router.put("/:isbn", validToken, validParams(bookParamsSchema), validBody(bookUpdateSchema), updateBook);
router.delete("/:isbn", validToken, validParams(bookParamsSchema), deleteBook);
router.patch("/:isbn/favorite", validToken, validParams(bookParamsSchema), toggleFavorite);
```

**Funcionalidades:**
- **GET /books** - Lista com pagina√ß√£o, busca e filtro de favoritos
- **POST /books** - Cria novo livro com valida√ß√£o completa
- **GET /books/:isbn** - Detalhes de livro espec√≠fico
- **PUT /books/:isbn** - Atualiza√ß√£o completa do livro
- **DELETE /books/:isbn** - Remo√ß√£o do livro
- **PATCH /books/:isbn/favorite** - Toggle status de favorito

### **üîê Autentica√ß√£o (`/auth`)**
```typescript
// src/routes/auth.route.ts
router.post("/signin", validBody(userAcessSchema), signin);
router.post("/refresh", validRefreshToken, refresh);
router.post("/logout", validToken, logout);
```

**Funcionalidades:**
- **POST /auth/signin** - Login com credenciais
- **POST /auth/refresh** - Renova√ß√£o de access token via refresh token
- **POST /auth/logout** - Logout e invalida√ß√£o de tokens

### **üë§ Usu√°rios (`/user`)**
```typescript
// src/routes/user.route.ts
router.post("/signup", validBody(userAcessSchema), signup);
router.post("/guest", createGuestAccount);
```

**Funcionalidades:**
- **POST /user/signup** - Cadastro de novo usu√°rio
- **POST /user/guest** - Cria√ß√£o de conta tempor√°ria de visitante

### **üìä Observabilidade (`/observability`)**
```typescript
// src/routes/log.route.ts
router.get("/", validToken, getSummary);
router.get("/errors", validToken, getError500Rate);  
router.get("/heatmap", validToken, getHeatMap);
```

**Funcionalidades:**
- **GET /observability** - Dashboard completo com todas as m√©tricas
- **GET /observability/errors** - Taxa de erros 500 detalhada
- **GET /observability/heatmap** - Mapa de calor de uso das funcionalidades

---

## üß™ **Cobertura de Testes**

### **Estat√≠sticas Finais**
```
üìä Resultados dos Testes:
‚úÖ 202 testes APROVADOS
‚úÖ 16 su√≠tes de teste
‚úÖ 0 falhas
‚ö° Tempo: ~15 segundos
üéØ Cobertura: Routes, Controllers, Services, Repositories
```

### **Tipos de Testes**

**1. Testes Unit√°rios**
```typescript
// src/__tests__/unit/services/log.service.test.ts
describe("Log Service", () => {
  it("deve calcular taxa de erro 500 corretamente", async () => {
    mockRepository.getTotalLogs.mockResolvedValue(100);
    mockRepository.getError500Count.mockResolvedValue(5);
    
    const result = await service.getError500Rate();
    
    expect(result.rate).toBe("5.00");
  });
});
```

**2. Testes de Integra√ß√£o**
```typescript
// src/__tests__/user.repository.integration.test.ts
describe("User Repository Integration", () => {
  it("deve criar usu√°rio e validar persist√™ncia", async () => {
    const userData = { name: "testuser", password: "hash123" };
    
    const createdUser = await repository.signup(userData);
    const foundUser = await repository.getUserById(createdUser._id);
    
    expect(foundUser?.name).toBe(userData.name);
  });
});
```

**3. Testes de Rotas**
```typescript
// src/__tests__/book.routes.test.ts
describe("GET /books", () => {
  it("deve retornar livros do usu√°rio autenticado", async () => {
    const response = await request(app)
      .get("/books")
      .set("Authorization", `Bearer ${accessToken}`)
      .expect(200);
      
    expect(response.body.success).toBe(true);
    expect(response.body.data.books).toBeDefined();
  });
});
```

---

## üê≥ **Deploy e Ambiente**

### **Ambiente de Desenvolvimento**
```bash
# üõ†Ô∏è MongoDB Local + Hot Reload
./start.sh dev

# Servi√ßos dispon√≠veis:
# Frontend: http://localhost:5173
# Backend:  http://localhost:8080
# MongoDB: mongodb://localhost:27017/bookstack
```

### **Ambiente de Produ√ß√£o**  
```bash
# üöÄ MongoDB Atlas + Build Otimizado
./start.sh prod

# Usa MongoDB Atlas:
# mongodb+srv://user:pass@cluster.mongodb.net/bookstack
```

### **Scripts de Gerenciamento**
```bash
./start.sh stop    # Para todos os containers
./start.sh logs    # Mostra logs em tempo real
./start.sh clean   # Remove containers e volumes
```

### **Docker Multistage Otimizado**
```dockerfile
# Dockerfile - Produ√ß√£o otimizada
FROM node:20-alpine AS builder
WORKDIR /app
RUN npm install -g pnpm
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --no-frozen-lockfile
COPY . .
RUN pnpm run build

FROM node:20-alpine AS production
WORKDIR /app  
RUN npm install -g pnpm
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --no-frozen-lockfile --prod
COPY --from=builder /app/dist ./dist
EXPOSE 8080
CMD ["node", "dist/server.js"]
```

**Benef√≠cios:**
- **Imagem final pequena**: Apenas depend√™ncias de produ√ß√£o
- **Build isolado**: Separa√ß√£o entre build e runtime
- **Seguran√ßa**: Sem ferramentas de desenvolvimento em produ√ß√£o

---

## üîß **Configura√ß√£o e Vari√°veis**

### **Vari√°veis de Ambiente**
```env
# .env.example
MONGODB_URI=mongodb://localhost:27017/bookstack
PORT=8080
ACCESS_TOKEN_SECRET=your_super_secret_access_key_here
REFRESH_TOKEN_SECRET=your_super_secret_refresh_key_here
NODE_ENV=development
```

### **Scripts Package.json**
```json
{
  "scripts": {
    "dev": "tsx watch src/server.ts",           // Desenvolvimento com hot reload
    "build": "tsc -p tsconfig.build.json",     // Build para produ√ß√£o
    "start": "node dist/server.js",            // Produ√ß√£o
    "test": "jest",                            // Todos os testes
    "test:watch": "jest --watch",              // Testes em watch mode
    "test:coverage": "jest --coverage",        // Cobertura de testes
    "lint": "biome check src/",                // Linting
    "lint:fix": "biome check src/ --apply"     // Fix autom√°tico
  }
}
```

---

## üéØ **Stack Tecnol√≥gico Completo**

### **Backend Core**
- **üü¢ Node.js 20** - Runtime JavaScript moderno
- **‚ö° Express.js 4** - Framework web minimalista
- **üî∑ TypeScript 5** - Tipagem est√°tica e produtividade
- **üçÉ MongoDB + Mongoose** - Banco NoSQL com ODM

### **Seguran√ßa e Valida√ß√£o**
- **üîê JWT (jsonwebtoken)** - Autentica√ß√£o stateless
- **üõ°Ô∏è bcrypt** - Hash seguro de senhas
- **‚úÖ Zod** - Valida√ß√£o de schemas em runtime
- **üîí CORS** - Controle de acesso cross-origin

### **Qualidade e Testes**
- **üß™ Jest** - Framework de testes robusto
- **üé≠ Supertest** - Testes de integra√ß√£o HTTP
- **üìä MongoDB Memory Server** - Testes com banco em mem√≥ria
- **üîç Biome** - Linting e formata√ß√£o ultrarr√°pida

### **DevOps e Deploy**
- **üê≥ Docker** - Containeriza√ß√£o e deploy
- **üì¶ pnpm** - Gerenciador de pacotes eficiente
- **‚ö° tsx** - Execu√ß√£o TypeScript em desenvolvimento
- **üîÑ Docker Compose** - Orquestra√ß√£o multi-container

---

## üöÄ **Como Executar o Projeto**

### **1. Pr√©-requisitos**
```bash
# Instalar Docker e Docker Compose
docker --version
docker compose version

# Opcional: Node.js 20+ para desenvolvimento local
node --version
```

### **2. Configura√ß√£o Inicial**
```bash
# Clone do reposit√≥rio
git clone <repo-url>
cd BookStack

# Configurar vari√°veis de ambiente
cd Express-BookStack
cp .env.example .env
# Editar .env com suas configura√ß√µes

cd ../Vue-BookStack  
cp .env.example .env
# Editar .env com URL do backend
```

### **3. Execu√ß√£o com Docker**
```bash
# Desenvolvimento (MongoDB local)
cd Vue-BookStack
./start.sh dev

# Produ√ß√£o (MongoDB Atlas)  
./start.sh prod

# Parar servi√ßos
./start.sh stop

# Ver logs
./start.sh logs

# Limpeza completa
./start.sh clean
```

### **4. Desenvolvimento Local (Opcional)**
```bash
# Backend
cd Express-BookStack
pnpm install
pnpm dev

# Frontend (terminal separado)
cd Vue-BookStack  
pnpm install
pnpm dev
```

---

Este projeto demonstra **expertise completa** em desenvolvimento backend moderno, desde arquitetura escal√°vel at√© observabilidade em produ√ß√£o, representando as melhores pr√°ticas da ind√∫stria. üöÄ
